# webserv 設定ファイル仕様定義

## 1. 基本構造 (Block Structure)
設定ファイル全体はブロック構造を持ちます。
*   **server ブロック:** 1つのウェブサイト（バーチャルホスト）を定義します。ファイル内に複数の `server` ブロックを記述可能とします。
*   **location ブロック:** URLのパス（ルート）ごとのルールを定義します。`server` ブロックの内部に記述します。

## 2. ディレクティブ (Directives)

以下のディレクティブを実装します。

**Server コンテキスト (server ブロック内)**

| ディレクティブ名 | 引数 | 説明 / 要件対応 |
| :--- | :--- | :--- |
| `listen`<br>(省略不可／複数定義可能) | `host:port` | サーバーがリッスンするIPとポートを指定します（例: `127.0.0.1:8080`）。 |
| `server_name`<br>(省略時 空白扱い) | `name` | **バーチャルホスト用**。リクエストの `Host` ヘッダーと照合するドメイン名を指定します。同一のポートに対して、複数のserver_nameを定義することを認めます。 |
| `root`<br>(省略不可) | `path` | ドキュメントルート。URLに対応するファイルシステムの起点ディレクトリ。 |
| `index`<br>(省略時デフォルト適用) | `file` | ディレクトリへのリクエスト時に返すデフォルトファイル（例: `index.html`）。 |
| `error_page`<br>(省略時デフォルト適用) | `code path` | 特定のHTTPエラーコードに対するデフォルトエラーページへのパスを指定します。 |
| `client_max_body_size`<br>(省略時デフォルト適用) | `size` | リクエストボディ（アップロードファイル等）の最大サイズ制限（バイト単位またはMB）。 |


**Location コンテキスト (location ブロック内)**
※ Server コンテキストの設定を上書き可能です。

| ディレクティブ名 | 引数 | 説明 / 要件対応 |
| :--- | :--- | :--- |
| `allow_methods`<br>(省略時デフォルト適用) | `methods...` | そのルートで許可されるHTTPメソッド（`GET`, `POST`, `DELETE`）のリスト。 |
| `return`<br>(省略時機能off) | `code url` | HTTPリダイレクトの設定（例: `301 http://google.com`）。 |
| `autoindex`<br>(省略時off適用) | `on/off` | ディレクトリリスティングの有効/無効設定。 |
| `upload_store`<br>(省略時機能off) | `path` | ファイルアップロード（POST）を受け入れた際の保存先ディレクトリ。 |
| `cgi_extension`<br>(省略時機能off) | `ext path` | 特定の拡張子（例: `.php`）を実行するCGIバイナリへのパスを指定します。 |

---


## 3. 具体的な設定ファイル記述例 (`webserv.conf`)

以下は、この仕様に基づいた具体的な設定ファイルの例です。
ポート `8080` で2つの異なるドメイン（バーチャルホスト）をホストする設定です。

```nginx
# サーバー設定 1: デフォルトのウェブサイト
server {
    listen 127.0.0.1:8080;
    server_name localhost;
    
    # 共通設定
    root ./www/html;
    index index.html;
    client_max_body_size 10M;
    error_page 404 /errors/404.html;

    # ルートディレクトリの設定
    location / {
        allow_methods GET POST;
        autoindex on;
    }

    # アップロード専用パス
    location /upload {
        allow_methods POST DELETE;
        root ./www/uploads;
        upload_store ./www/uploads/tmp;
    }

    # リダイレクトのテスト
    location /old-page {
        return 301 /new-page.html;
    }

    # CGI設定 (拡張子ベース)
    location /cgi-bin {
        root ./www/cgi-bin;
        allow_methods GET POST;
        index time.py;
        cgi_extension .py /usr/bin/python3;
        cgi_extension .php /usr/bin/php-cgi;
    }
}

# サーバー設定 2: バーチャルホスト (同じポートだが名前が異なる)
server {
    listen 127.0.0.1:8080;
    server_name example.com noname.com;

    root ./www/example_site;
    index home.html;
    client_max_body_size 100; # 小さい制限のテスト

    location / {
        allow_methods GET;
        autoindex off;
        cgi_extension .py /usr/bin/python3;
    }
}
```

## 4. 実装におけるポイント（要件との整合性）

1.  **バーチャルホストの識別ロジック:**
    *   サーバーは `listen` で指定されたポートで接続を受け付けます。
    *   リクエストを受け取った後、HTTPヘッダーの **`Host`** フィールドを解析します。
    *   設定ファイル内の `server_name` と `Host` ヘッダーが一致する `server` ブロックを選択して処理を行います（一致しない場合はデフォルト、通常は最初のブロックを使用）。

2.  **Locationのマッチング:**
    *   NGINXと同様に、リクエストURIに対して「前方一致（prefix match）」で `location` ブロックを探します。最も長く一致するパス（longest match）を持つブロックの設定を適用します。

    *   **オプション: 後方一致（suffix match）**
        *   末尾一致で location を選びたい場合、`location` の直後に `back` を付けて定義できます。
        *   **定義方法:** `location back <pattern> { ... }`
        *   **具体例:**

            location back /cgi-bin {
                root ./www;
                allow_methods GET;
            }

        *   **マッチ例（概念）:**
            *   Request: `/app/cgi-bin` → pattern=`/cgi-bin` に一致（末尾一致）
            *   Request: `/cgi-bin/app` → 不一致

        *   注意:
            *   `pattern` は通常の location と同様に `/` で始まる必要があります。
            *   prefix/suffix の両方が存在する場合も含め、最終的な location 選択は「最長一致（longest match）」のルールに従います。

3.  **CGIの扱い:**
    *   拡張子に基づくCGI実行を行います。上記の例では `cgi_extension` ディレクティブを使って、「`.py` が来たら `/usr/bin/python3` で実行する」というマッピングを定義しています。




## 5. 必須要件

### 1. 完全に省略できない項目（必須）

これらが設定ファイルに記述されていない場合、サーバーはどこで待ち受けるべきか、どのファイルを提供すべきか判断できないため、設定ファイルがエラー扱いになります。

*   **`listen` (ポート番号とホスト)**
    *   **理由:** サーバーが接続を受け付けるインターフェースとポートのペアを定義する必要があります。これがなければ、`socket`、`bind`、`listen` のシステムコールを実行するための情報が不足し、通信を開始できません。
*   **`root` (ドキュメントルート)**
    *   **理由:** リクエストされた URL（例: `/`）を、サーバー内の物理的なディレクトリ（例: `/var/www/html`）に紐付けるための起点です。これがないと、クライアントからリクエストが来ても、サーバーはどのファイルを読み込んで返せばよいか特定できません。

```nginx
server {
    listen 8080;      # 必須：どこで待ち受けるか
    root ./www/html;  # 必須：どこからファイルを探すか
}
```
これ以外の項目（メソッド制限、エラーページ、CGIなど）は、設定ファイルでは省略可能です。

---

### 2. 省略してもよい（デフォルト値で代用可能な）項目

以下の項目は、**設定ファイルへの記述は省略可能**です。記述がない場合、事前に定義されたデフォルトの挙動で扱われます。

*   **`error_page` (エラーページ)**
    *   省略した場合、デフォルトのエラーページが表示されます。
*   **`client_max_body_size` (最大ボディサイズ)**
    *   省略した場合はデフォルト値（1MB）が適用されます。
*   **`index` (デフォルトファイル)**
    *   記述がない場合は `index.html` がデフォルトとして設定されますが、`autoindex` がonの場合はディレクトリリストが表示されます。
*   **`allow_methods` (HTTPメソッド)**
    *   省略した場合は「GETのみ許可」が設定されます。
*   **`return`**
    *   省略時機能offが適用されます。
*   **`autoindex`**
    *   省略時offが適用されます。
*  **`upload_store`**
    *   省略時機能offが適用されます。
*   **`cgi_extension`**
    *   省略時機能offが適用されます。

## 6. path / url の記述・パース仕様

confファイル内のpathとurlをプログラム（パーサー）がどう読み込み、**どのような文字列として変数に保持すべきか**を定義します。

**基本方針:**
*   **物理パス系 (`root`, `upload_store`, `cgi_extension`):** 起動時に「綺麗な絶対パス」に解決（Resolve）して保持します。
*   **URI/URL系 (`error_page`, `return`):** パス解決を行わず、記述された「文字列のまま」保持します。
*   正規表現には対応しません。
*   \ (バックスラッシュ) は変換せずにそのまま文字として扱います。

#### ① `root` / `upload_store` (物理パス系)
サーバー内のディレクトリを指すものです。

| 項目 | 仕様・実装方針 |
| :--- | :--- |
| **絶対パス** | **対応します**。`/` から始まるpathについて絶対パスとして扱います。<br>例: `root /var/www/html;` |
| **相対パス** | **対応します**。サーバーの実行ディレクトリ（PWD）を基準に絶対パスへ変換します。<br>例: `root html;` → `/current/dir/html` |
| **`..` (親移動)** | **使用可能**。パース時に解決（消去）します。<br>例: `root ../www;` → `/current/www` |
| **`//` (連続/)** | **使用可能**。パース時に `/` に置換（正規化）します。※ スラッシュが何個連続していても、単一の / に置換します。<br>例: `/var///www` → `/var/www` |
| **保持する値** | **正規化された絶対パス** (`std::string`) |

**記述例:**
```nginx
root ./www/html;           # 相対パス
upload_store /tmp/uploads; # 絶対パス
```

#### ② `cgi_extension` (物理パス系)
CGIを実行するためのバイナリファイルの場所です。

| 項目 | 仕様・実装方針 |
| :--- | :--- |
| **絶対パス** | **対応します**。`/` から始まるpathについて絶対パスとして扱います。<br>例: `/usr/bin/python3` |
| **相対パス** | **対応します**。PWD基準で解決します。<br>例: `./cgi_bin/php-cgi` |
| **`..` (親移動)** | **使用可能**。パース時に解決（消去）します。 |
| **`//` (連続/)** | **使用可能**。パース時に `/` に置換（正規化）します |
| **保持する値** | **正規化された絶対パス** (`std::string`)<br>※ `execve` の第一引数にそのまま渡せる状態にします。 |

**記述例:**
```nginx
cgi_extension .php /usr/bin/php-cgi;
cgi_extension .py  ./tester/ubuntu_cgi_tester;
```

#### ③ `return` (URI/URL系)
クライアントをリダイレクトさせる先です。

| 項目 | 仕様・実装方針 |
| :--- | :--- |
| **絶対パス** | **対応します**。**URIパス** (`/`開始) または **完全なURL** (`http://`等)について絶対パスとして扱います。※ 物理パスとは扱いが異なります。 |
| **相対パス** | 非対応。`./` から始まる場合はエラーになります。※ 必ず絶対パスを使用する（必ず `/` またはプロトコルで始める）必要があります。 |
| **`..` (親移動)** | **解決しない**。文字列としてそのまま保持します。「..」としてクライアントに返します（※ ブラウザが解決します）。 |
| **`//` (連続/)** | **正規化しない**。そのまま保持します。 |
| **保持する値** | **記述されたままの文字列** (`std::string`) |

**記述例:**
```nginx
return 301 https://google.com;  # 完全なURL
return 301 /new-page.html;      # 内部パス（URI）
```

#### ④ `error_page` (URI/URL系)
エラー発生時に表示するリソース、またはリダイレクト先です。

| 項目 | 仕様・実装方針 |
| :--- | :--- |
| **絶対パス** | **対応します**。**URIパス** (`/`開始) または **完全なURL** (`http://`等)について絶対パスとして扱います。※ `/404.html` は「ルートディレクトリにある404.html」を指すURIとして扱われます。 |
| **相対パス** | 非対応。`./` から始まる場合はエラーになります。※ 必ず絶対パスを使用する（必ず `/` またはプロトコルで始める）必要があります |
| **`..` (親移動)** | **解決しない**。文字列としてそのまま保持します。 |
| **`//` (連続/)** | **正規化しない**。そのまま保持します。 |
| **保持する値** | **記述されたままの文字列** (`std::string`) |

**記述例:**
```nginx
error_page 404 /404.html;             # 内部URI
error_page 500 http://example.com/err;# 外部URL
```


## 7. FAQ


### 1. server_nameが省略された場合
**実装挙動:** `""`無名（空文字列）として扱われます。
**実装説明:**
通常、同一ポートのバーチャルホストで１番最初に定義されたサーバーブロックがデフォルトとなりますが、
同一ポートへのリクエストで `Host` ヘッダーが他のどの `server_name` にもマッチしなかった場合に、この空文字列のサーバーブロックがリクエストを処理します（デフォルトサーバーとなります）
同一ポートで無名のバーチャルサーバーが複数ある場合は、１番最初に定義された無名バーチャルサーバーが処理します。

### 2. 同じlisten ポートとserver_nameが複数定義された場合
**実装挙動:** 設定ファイルがエラーとして扱われます。
**実装説明:**
どのサーバーブロックで処理すべきかプログラム側で一意に決定できなくなるため、設定ファイルの解析段階（パース時）で検出してエラー終了します。

### 3. 別のlistenポートで同じserver_nameの場合は？
**実装挙動:** 問題なく許容されます。
**実装説明:**
**別扱いとして実装します。**
ポート `8080` の `example.com` と、ポート `8081` の `example.com` は、ソケット（socket fd）自体が異なるため、完全に独立したサーバー設定として扱われます。

### 4. listenの定義でhostを省略して書いた場合 (例: `listen 80;`, `listen :8080;`)
**実装挙動:** `0.0.0.0`（すべてのインターフェース）にバインドされます。
**実装説明:**
`127.0.0.1` ではなく、**`0.0.0.0` (INADDR_ANY)** が適用されます。
この設定の場合、ローカルホストだけでなく、外部IPからのアクセスも受け付けるようになります。

### 5. listenの書き方で、`localhost:8080` は許されるのか？
**実装挙動:** 許容されます。
**実装説明:**
許可されている外部関数 `getaddrinfo` を使用して、ドメイン名（`localhost`）をIPアドレス（`127.0.0.1`）に解決します。設定ファイル内でホスト名が指定された場合は、解決してバインドされます。

### 6. allow_methodsは同じものを何回書いてもOKとするのか？ (例: `GET GET POST`)
**実装挙動:** 重複定義は許されます。
**実装説明:**
重複を取り除いて（ユニークにする）単一の設定としてマージされます。

