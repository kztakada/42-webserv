# HTTPリクエスト時のpath解決の扱い（実行時の処理）

ここでは、クライアントから送られてきたリクエスト（例: `GET /foo/bar.html`）を、上記の設定値と組み合わせてどう処理するかを整理します。

#### ① 基本的なパス解決（root との結合）
リクエストされた URI と、設定された `root` を結合して、操作対象の物理ファイルを特定します。

*   **処理:** `正規化されたroot` + `リクエストURI`
*   **例:**
    *   Conf: `root /var/www;`
    *   Request: `GET /images/logo.png`
    *   Result: `/var/www/images/logo.png`

#### ② リクエスト内の `..` (親ディレクトリ移動) の扱い
**ここが最も重要です。**

*   **扱い:** **セキュリティリスク（ディレクトリトラバーサル）として処理します。**
*   **挙動:**
    1.  リクエストURIを正規化します（`//` を `/` に、`..` を論理的に解決）。
    2.  解決結果が「ルートディレクトリより上」に行こうとした場合（例: `root` 結合前に `/../` が残る、または結合後のパスが `root` の範囲外になる）、**400 Bad Request** または **403 Forbidden**、**404 Not Found** を返します。
*   **注意:** Confファイル内の `..` は「管理者の意図」なので許可されますが、リクエスト内の `..` は「攻撃の可能性」があるため拒否します。

#### ③ リクエスト内の `//` (連続スラッシュ) の扱い
*   **扱い:** 単一の `/` として扱います。
*   **実装:** リクエストを受け取った直後のパース段階で `/` に置換します。これにより、`location` のマッチング漏れを防げます。

#### ④ `error_page` の発動処理
エラー（例: 404）が発生した際、保持していた `error_page` の文字列を使います。

*   **文字列が `http` で始まる場合:**
    *   クライアントへ `302 Found` と `Location: <そのURL>` を返します。
*   **文字列が `/` で始まる場合 (例: `/404.html`):**
    *   **内部リダイレクト**を行います。
    *   メソッドを `GET`、URI を `/404.html` に書き換えたと仮定して、再度自サーバー内で処理を回します（`root` + `/404.html` を探しに行く）。

---

### まとめ：実装者向けチートシート

| 設定項目 | Confでのパース処理 (文字列保持) | 実行時 (Request) での役割 |
| :--- | :--- | :--- |
| **root** | **絶対パス化** (`PWD`基準), `..`解決, `//`除去 | `リクエストURI` と結合してファイルを探す起点。 |
| **upload_store** | **絶対パス化** (`PWD`基準), `..`解決, `//`除去 | ファイル保存時のディレクトリパスとして使用。 |
| **cgi_extension** | **絶対パス化** (`PWD`基準), `..`解決, `//`除去 | `execve` の第1引数（コマンドパス）として使用。 |
| **return** | **そのまま保持** (URI/URLとして扱う) | ステータスコードと共に `Location` ヘッダーの値になる。 |
| **error_page** | **そのまま保持** (URI/URLとして扱う) | エラー時に「外部リダイレクト」または「内部URI再処理」の宛先になる。 |

**リクエストURI (GET /path...) の扱い:**
*   `//` は `/` に直す。
*   `..` を含むパス解決を行い、**`root` の外に出る場合はエラーにする**。


<br>

---


## `cgi_extension` の値の扱いについてのより具体的な解説

### 1. `cgi_extension` の値と `root` の扱いの違い

結論から申し上げますと、**扱いは根本的に異なります**。

*   **`root`**: リクエストされたURI（ファイル名）と**結合するための「ディレクトリ」**です。
*   **`cgi_extension`**: リクエストされたURIとは結合せず、そのまま**実行する「プログラム（バイナリ）のパス」**です。

`execve` 関数 を使う場面を想定すると、その違いが明確になります。

#### 具体例での比較

以下の設定とリクエストがあったと仮定します。

*   **設定:**
    ```nginx
    root /var/www/html;
    cgi_extension .php /usr/bin/php-cgi;
    ```
*   **リクエスト:**
    `GET /index.php`

このとき、サーバー内部では以下のようにデータが処理されます。

**A. `root` の処理（ターゲットファイルの特定）**
`root` はリクエストURIと**結合**されます。
*   計算式: `root` + `URI`
*   結果: `/var/www/html` + `/index.php` = **`/var/www/html/index.php`**
*   **役割:** これが「処理されるべきスクリプトファイル」のパスになります。

**B. `cgi_extension` の処理（実行プログラムの特定）**
`cgi_extension` で指定されたパス（`/usr/bin/php-cgi`）は、リクエストURIとは**結合しません**。
*   計算式: 設定値そのまま
*   結果: **`/usr/bin/php-cgi`**
*   **役割:** これが `execve` の第一引数（実行されるコマンド）になります。

#### `execve` 実行時のイメージ

C++コード上で `execve` を呼び出す際、引数は以下のようになります。

```cpp
// execve(path, argv, envp);

const char *path = "/usr/bin/php-cgi"; // cgi_extension で保持している値（そのまま使う）

char *argv[] = {
    "/usr/bin/php-cgi",      // argv: プログラム名
    "/var/www/html/index.php", // argv: rootと結合して見つけたスクリプトファイルのパス
    NULL
};

execve(path, argv, envp);
```

**違いのまとめ:**
*   **`root` の値:** 「後ろにファイルパスがくっつく」ことを前提とした**ディレクトリ**です。
*   **`cgi_extension` の値:** 後ろに何もくっつかない、独立した**実行ファイルの絶対パス**です。

